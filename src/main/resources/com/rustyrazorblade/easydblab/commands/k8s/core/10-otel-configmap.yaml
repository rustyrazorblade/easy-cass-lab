apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: default
  labels:
    app.kubernetes.io/name: otel-collector
data:
  otel-collector-config.yaml: |
    receivers:
      hostmetrics:
        collection_interval: 10s
        scrapers:
          cpu:
          disk:
          load:
          filesystem:
          memory:
          network:
          processes:
      prometheus:
        config:
          scrape_configs:
            - job_name: 'clickhouse'
              scrape_interval: 5s
              static_configs:
                - targets: ['localhost:9363']
      filelog/clickhouse-server:
        include:
          - /mnt/db1/clickhouse/logs/*.log
        start_at: end
        include_file_path: true
        include_file_name: true
        attributes:
          database: clickhouse
          component: server
        operators:
          - type: json_parser
            id: parse_json
            on_error: send
      filelog/clickhouse-keeper:
        include:
          - /mnt/db1/clickhouse/keeper/logs/*.log
        start_at: end
        include_file_path: true
        include_file_name: true
        attributes:
          database: clickhouse
          component: keeper
        operators:
          - type: json_parser
            id: parse_json
            on_error: send

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024
      memory_limiter:
        check_interval: 1s
        limit_mib: 256
        spike_limit_mib: 64
      resourcedetection:
        detectors: [system]
        system:
          hostname_sources: ["os"]
          resource_attributes:
            host.name:
              enabled: true

    exporters:
      prometheusremotewrite:
        endpoint: http://victoriametrics.default.svc.cluster.local:8428/api/v1/write
        tls:
          insecure: true
        resource_to_telemetry_conversion:
          enabled: true
      otlphttp/victorialogs:
        endpoint: http://victorialogs.default.svc.cluster.local:9428/insert/opentelemetry
        tls:
          insecure: true

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    service:
      extensions: [health_check]
      pipelines:
        metrics:
          receivers: [hostmetrics, prometheus]
          processors: [memory_limiter, resourcedetection, batch]
          exporters: [prometheusremotewrite]
        logs:
          receivers: [filelog/clickhouse-server, filelog/clickhouse-keeper]
          processors: [memory_limiter, resourcedetection, batch]
          exporters: [otlphttp/victorialogs]
