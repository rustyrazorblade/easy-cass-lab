apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: clickhouse
  namespace: default
  labels:
    app.kubernetes.io/name: clickhouse-server
spec:
  serviceName: clickhouse
  replicas: 2
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app.kubernetes.io/name: clickhouse-server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: clickhouse-server
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        type: db
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: clickhouse-server
              topologyKey: kubernetes.io/hostname
      initContainers:
        - name: wait-for-keeper
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for ClickHouse Keeper to be ready..."
              until nc -z clickhouse-keeper-0.clickhouse-keeper.default.svc.cluster.local 2181; do
                echo "Keeper not ready, sleeping..."
                sleep 5
              done
              echo "Keeper is ready!"
        - name: init-data-dir
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              mkdir -p /mnt/db1/clickhouse
              mkdir -p /mnt/db1/clickhouse/tmp
              mkdir -p /mnt/db1/clickhouse/user_files
              mkdir -p /mnt/db1/clickhouse/format_schemas
              mkdir -p /mnt/db1/clickhouse/disks/s3_disk
              mkdir -p /mnt/db1/clickhouse/disks/s3_cache
              mkdir -p /mnt/db1/clickhouse/logs
              chown -R 101:101 /mnt/db1/clickhouse
          volumeMounts:
            - name: data
              mountPath: /mnt/db1/clickhouse
      containers:
        - name: clickhouse
          image: clickhouse/clickhouse-server:latest
          securityContext:
            runAsUser: 101
            runAsGroup: 101
          ports:
            - containerPort: 8123
              hostPort: 8123
              name: http
            - containerPort: 9000
              hostPort: 9000
              name: native
            - containerPort: 9009
              name: interserver
            - containerPort: 9363
              name: metrics
          env:
            - name: SHARD
              value: "1"
            - name: REPLICA
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          envFrom:
            - secretRef:
                name: clickhouse-s3-credentials
                optional: true
          command:
            - /bin/bash
            - -c
            - |
              umask 0022
              exec /entrypoint.sh
          resources:
            limits:
              memory: 4Gi
            requests:
              memory: 2Gi
              cpu: 500m
          volumeMounts:
            - name: config
              mountPath: /etc/clickhouse-server/config.d
              readOnly: true
            - name: users
              mountPath: /etc/clickhouse-server/users.d
              readOnly: true
            - name: data
              mountPath: /mnt/db1/clickhouse
          livenessProbe:
            httpGet:
              path: /ping
              port: 8123
            initialDelaySeconds: 30
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /ping
              port: 8123
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: clickhouse-server-config
            items:
              - key: config.xml
                path: config.xml
        - name: users
          configMap:
            name: clickhouse-server-config
            items:
              - key: users.xml
                path: users.xml
        - name: data
          hostPath:
            path: /mnt/db1/clickhouse
            type: DirectoryOrCreate
