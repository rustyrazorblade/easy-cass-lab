apiVersion: v1
kind: ConfigMap
metadata:
  name: clickhouse-server-config
  namespace: default
  labels:
    app.kubernetes.io/name: clickhouse-server
data:
  config.xml: |
    <clickhouse>
        <logger>
            <level>information</level>
            <log>/mnt/db1/clickhouse/logs/clickhouse-server.log</log>
            <errorlog>/mnt/db1/clickhouse/logs/clickhouse-server.err.log</errorlog>
            <formatting>
                <type>json</type>
            </formatting>
        </logger>
        <listen_host>0.0.0.0</listen_host>
        <http_port>8123</http_port>
        <tcp_port>9000</tcp_port>
        <interserver_http_port>9009</interserver_http_port>

        <path>/mnt/db1/clickhouse/</path>
        <tmp_path>/mnt/db1/clickhouse/tmp/</tmp_path>
        <user_files_path>/mnt/db1/clickhouse/user_files/</user_files_path>
        <format_schema_path>/mnt/db1/clickhouse/format_schemas/</format_schema_path>

        <!-- Storage Configuration -->
        <!-- Available policies: 'local' (default), 's3_main' (S3 with local cache) -->
        <storage_configuration>
            <disks>
                <default>
                    <keep_free_space_bytes>1073741824</keep_free_space_bytes>
                </default>
                <s3_disk>
                    <type>s3</type>
                    <endpoint from_env="CLICKHOUSE_S3_ENDPOINT"/>
                    <use_environment_credentials>true</use_environment_credentials>
                    <metadata_path>/mnt/db1/clickhouse/disks/s3_disk/</metadata_path>
                </s3_disk>
                <s3_cache>
                    <type>cache</type>
                    <disk>s3_disk</disk>
                    <path>/mnt/db1/clickhouse/disks/s3_cache/</path>
                    <max_size>10Gi</max_size>
                </s3_cache>
            </disks>
            <policies>
                <local>
                    <volumes>
                        <main>
                            <disk>default</disk>
                        </main>
                    </volumes>
                </local>
                <s3_main>
                    <volumes>
                        <main>
                            <disk>s3_cache</disk>
                        </main>
                    </volumes>
                </s3_main>
            </policies>
        </storage_configuration>

        <zookeeper>
            <node>
                <host>clickhouse-keeper-0.clickhouse-keeper.default.svc.cluster.local</host>
                <port>2181</port>
            </node>
            <node>
                <host>clickhouse-keeper-1.clickhouse-keeper.default.svc.cluster.local</host>
                <port>2181</port>
            </node>
            <node>
                <host>clickhouse-keeper-2.clickhouse-keeper.default.svc.cluster.local</host>
                <port>2181</port>
            </node>
        </zookeeper>

        <macros>
            <cluster>easy_db_lab</cluster>
            <shard from_env="SHARD"/>
            <replica from_env="REPLICA"/>
        </macros>

        <remote_servers>
            <easy_db_lab>
                <shard>
                    <replica>
                        <host>clickhouse-0.clickhouse.default.svc.cluster.local</host>
                        <port>9000</port>
                    </replica>
                    <replica>
                        <host>clickhouse-1.clickhouse.default.svc.cluster.local</host>
                        <port>9000</port>
                    </replica>
                </shard>
            </easy_db_lab>
        </remote_servers>

        <distributed_ddl>
            <path>/clickhouse/task_queue/ddl</path>
        </distributed_ddl>

        <prometheus>
            <endpoint>/metrics</endpoint>
            <port>9363</port>
            <metrics>true</metrics>
            <events>true</events>
            <asynchronous_metrics>true</asynchronous_metrics>
        </prometheus>
    </clickhouse>
  users.xml: |
    <clickhouse>
        <users>
            <default>
                <password></password>
                <networks>
                    <ip>::/0</ip>
                </networks>
                <profile>default</profile>
                <quota>default</quota>
                <access_management>1</access_management>
            </default>
        </users>
        <profiles>
            <default>
                <max_memory_usage>10000000000</max_memory_usage>
            </default>
        </profiles>
        <quotas>
            <default>
                <interval>
                    <duration>3600</duration>
                    <queries>0</queries>
                    <errors>0</errors>
                    <result_rows>0</result_rows>
                    <read_rows>0</read_rows>
                    <execution_time>0</execution_time>
                </interval>
            </default>
        </quotas>
    </clickhouse>
