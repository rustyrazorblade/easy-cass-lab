#!/bin/bash

CASSANDRA_VERSIONS="/etc/cassandra_versions.yaml"

# set cassandra version to $1
sudo ln -vfns /usr/local/cassandra/$1 /usr/local/cassandra/current
sudo ln -vfns /usr/local/cassandra/$1/conf /etc/cassandra

# hacky, not really what I want long term but whatever.
sudo chown -R cassandra:cassandra /usr/local/cassandra

# set the java version
export VERSION=$1

export JAVA_VERSION=$(yq e '.[] | select(.version == env(VERSION)).java' $CASSANDRA_VERSIONS)
echo "Using java version from cassandra_versions.yaml: $JAVA_VERSION"

export PY_VERSION=$(yq e '.[] | select(.version == env(VERSION)).python' $CASSANDRA_VERSIONS)

if [ -z "$JAVA_VERSION" ]; then
  echo "No java version found for $VERSION"
  exit 1
fi

if [ -z "$PY_VERSION" ]; then
  echo "No python version found for $VERSION"
  exit 1
fi

# Get the architecture using uname
cpu_arch=$(uname -m)

# Set ARCH based on the CPU architecture
if [[ "$cpu_arch" == "x86_64" ]]; then
    ARCH="amd64"
elif [[ "$cpu_arch" == "aarch64" ]]; then
    ARCH="arm64"
else
    echo "Unsupported architecture: $cpu_arch"
    exit 1
fi

# if java version = 8 then run update-java-alternatives -s java-1.8.0-openjdk-amd64
if [ "$JAVA_VERSION" = "8" ]; then
  sudo update-java-alternatives -s java-1.8.0-openjdk-$ARCH
# if java version = 11 then run update-java-alternatives -s java-1.11.0-openjdk-amd64
elif [ "$JAVA_VERSION" = "11" ]; then
  sudo update-java-alternatives -s java-1.11.0-openjdk-$ARCH
elif [ "$JAVA_VERSION" = "17" ]; then
  sudo update-java-alternatives -s java-1.17.0-openjdk-$ARCH
else
  echo "Unknown java version $JAVA_VERSION"
  exit 1
fi

# set python version using update-alternatives
# Extract major.minor version from full version (e.g., "3.10.6" -> "3.10", "2.7.18" -> "2.7")
PY_MAJOR_MINOR=$(echo "$PY_VERSION" | cut -d. -f1,2)
PY_ALTERNATIVE="/usr/bin/python${PY_MAJOR_MINOR}"

# Validate that the requested Python version is installed
if [ ! -f "$PY_ALTERNATIVE" ]; then
  echo "Error: Python version $PY_VERSION (${PY_ALTERNATIVE}) is not installed"
  exit 1
fi

# Switch Python version using update-alternatives
sudo update-alternatives --set python "$PY_ALTERNATIVE"
echo "Switched to Python $PY_VERSION (${PY_ALTERNATIVE})"
